{
	"$schema":"http://schema.management.azure.com/schemas/2015-01-01-preview/deploymentTemplate.json",
	"contentVersion":"1.0.0.0",
	"parameters":{
			"vmSSName":{
						"type":"string",
						"metadata":{
								"description":"TheNameoftheScaleset"
						}
				},
				"instanceCount":{
						"type":"string",
						"metadata":{
								"description":"NumberofVMinstances"
						}
				},
				"newStorageAccountSuffix":{
					"type":"string",
						"metadata":{
								"description":"ThePrefixforthenamesofthenewstorageaccountscreated"
						}
				},
				"dnsNamePrefix":{
					"type":"string",
						"metadata":{
								"description":"ThePrefixfortheDNSnamesofthenewIPaddresscreated"
						}
				},
				"adminUsername":{
					"type":"string",
						"metadata":{
								"description":"TheUsernameoftheadmininstrativeuserforeachvmcreated"
						}
				},
				"adminPassword":{
					"type":"securestring",
						"metadata":{
								"description":"ThePasswordoftheadmininstrativeuserforeachvmcreated"
						}
				},
				"location":{
					"type":"string",
					"metadata":{
							"description":"Deploymentlocation"
						},
					"defaultValue":"[resourceGroup().location]"
				},
				"baseURL":{
					"type":"string",
					"metadata":{
							"description":"TheBaseURLfortheDSCconfigurationpackage"
						},
					"defaultValue":"https://sdaviesms.blob.core.windows.net/customscripts/"
				},
	},
	"variables":{
			"iisConfigurationScriptLocation":"[concat(parameters('baseURL'),'install-iis-and-default-web-app.ps1')]",
			"iisConfigurationScriptFile":"install-iis-and-default-web-app.ps1",
			"imagePublisher":"MicrosoftWindowsServer",
			"imageOffer":"WindowsServer",
			"imageVersion":"2012-R2-Datacenter",
			"addressPrefix":"10.0.0.0/16",
			"subnetName":"Subnet",
			"subnetPrefix":"10.0.0.0/24",
			"virtualNetworkName":"vmssvnet",
			"storageAccountType":"Standard_LRS",
			"vnetID":"[resourceId('Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]",
			"subnetRef":"[concat(variables('vnetID'),'/subnets/',variables('subnetName'))]",
			"publicIPAddressName":"publicip1",
			"publicIPAddressID":"[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]",
			"nicName":"networkInterface1",
			"nicId":"[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]",
			"lbName":"loadBalancer1",
			"lbID":"[resourceId('Microsoft.Network/loadBalancers',variables('lbName'))]",
			"lbFEName":"loadBalancerFrontEnd",
			"lbWebProbeName":"loadBalancerWebProbe",
			"lbBEAddressPool":"loadBalancerBEAddressPool",
			"lbFEIPConfigID":"[concat(variables('lbID'),'/frontendIPConfigurations/',variables('lbFEName'))]",
			"lbBEAddressPoolID":"[concat(variables('lbID'),'/backendAddressPools/',variables('lbBEAddressPool'))]",
			"lbWebProbeID":"[concat(variables('lbID'),'/probes/',variables('lbWebProbeName'))]",
			"storageAccountPrefix":[
							"a","g","m","s","y"
			]
	},
	"resources":[
		{
				"type":"Microsoft.Storage/storageAccounts",
				"name":"[concat(variables('storageAccountPrefix')[copyIndex()],parameters('newStorageAccountSuffix'))]",
				"apiVersion":"2015-05-01-preview",
				"copy":{
					"name":"storageLoop",
					"count":5
				},
				"location":"[parameters('location')]",
				"properties":{
						"accountType":"[variables('storageAccountType')]"
				}
		},
		{
				"apiVersion":"2015-06-15",
				"type":"Microsoft.Network/virtualNetworks",
				"name":"[variables('virtualNetworkName')]",
				"location":"[parameters('location')]",
				"properties":{
						"addressSpace":{
								"addressPrefixes":[
										"[variables('addressPrefix')]"
								]
						},
						"subnets":[
								{
										"name":"[variables('subnetName')]",
										"properties":{
												"addressPrefix":"[variables('subnetPrefix')]"
										}
								}
						]
					}
		},
		{
					"apiVersion":"2015-05-01-preview",
					"type":"Microsoft.Network/publicIPAddresses",
					"name":"[variables('publicIPAddressName')]",
					"location":"[parameters('location')]",
					"properties":{
							"publicIPAllocationMethod":"Dynamic",
							"dnsSettings":{
									"domainNameLabel":"[parameters('dnsNamePrefix')]"
							}
					}
		},
		{
				"apiVersion":"2015-05-01-preview",
				"name":"[variables('lbName')]",
				"type":"Microsoft.Network/loadBalancers",
				"location":"[parameters('location')]",
				"dependsOn":[
						"[concat('Microsoft.Network/publicIPAddresses/',variables('publicIPAddressName'))]"
				],
				"properties":{
						"frontendIPConfigurations":[
								{
										"name":"[variables('lbFEName')]",
										"properties":{
												"publicIPAddress":{
														"id":"[variables('publicIPAddressID')]"
												}
										}
								}
						],
						"backendAddressPools":[
								{
										"name":"[variables('lbBEAddressPool')]"
								}
						],
					"loadBalancingRules":[
						{
							"name":"weblb",
							"properties":{
								"frontendIPConfiguration":{
									"id":"[variables('lbFEIPConfigID')]"
								},
								"backendAddressPool":{
									"id":"[variables('lbBEAddressPoolID')]"
								},
								"probe":{
									"id":"[variables('lbWebProbeID')]"
								},
								"protocol":"tcp",
								"frontendPort":80,
								"backendPort":80,
								"enableFloatingIP":false
							}
						}
					],
					"probes":[
						{
							"name":"[variables('lbWebProbeName')]",
							"properties":{
								"protocol":"http",
								"port":80,
								"intervalInSeconds":"15",
								"numberOfProbes":"5",
								"requestPath":"/iisstart.htm"
							}
						}
					]
				}
		},
		{
			"type":"Microsoft.Compute/virtualMachineScaleSets",
			"apiVersion":"2015-06-15",
			"name":"[parameters('vmSSName')]",
			"location":"[parameters('location')]",
			"tags":{
				"vmsstag1":"Myriad"
			},
			"dependsOn":[
					"[concat('Microsoft.Storage/storageAccounts/a',parameters('newStorageAccountSuffix'))]",
					"[concat('Microsoft.Storage/storageAccounts/g',parameters('newStorageAccountSuffix'))]",
					"[concat('Microsoft.Storage/storageAccounts/m',parameters('newStorageAccountSuffix'))]",
					"[concat('Microsoft.Storage/storageAccounts/s',parameters('newStorageAccountSuffix'))]",
					"[concat('Microsoft.Storage/storageAccounts/y',parameters('newStorageAccountSuffix'))]",
					"[concat('Microsoft.Network/loadBalancers/',variables('lbName'))]",
					"[concat('Microsoft.Network/virtualNetworks/',variables('virtualNetworkName'))]"

			],
			"sku":{
				"name":"Standard_A2",
				"tier":"Standard",
				"capacity":"[parameters('instanceCount')]"
			},
			"properties":{
				"upgradePolicy":{
				"mode":"Automatic"
				},
				"virtualMachineProfile":{
				"storageProfile":{
						"osDisk":{
							"vhdContainers":[
								"[concat('https://a',parameters('newStorageAccountSuffix'),'.blob.core.windows.net/vmss')]",
								"[concat('https://g',parameters('newStorageAccountSuffix'),'.blob.core.windows.net/vmss')]",
								"[concat('https://m',parameters('newStorageAccountSuffix'),'.blob.core.windows.net/vmss')]",
								"[concat('https://s',parameters('newStorageAccountSuffix'),'.blob.core.windows.net/vmss')]",
								"[concat('https://y',parameters('newStorageAccountSuffix'),'.blob.core.windows.net/vmss')]"
							],
							"name":"vmssosdisk",
							"caching":"ReadOnly",
							"createOption":"FromImage"
						},
						"imageReference":{
							"publisher":"[variables('imagePublisher')]",
							"offer":"[variables('imageOffer')]",
							"sku":"[variables('imageVersion')]",
							"version":"latest"
						}
					},
				"osProfile":{
					"computerNamePrefix":"[parameters('vmSSName')]",
					"adminUsername":"[parameters('adminUsername')]",
					"adminPassword":"[parameters('adminPassword')]"
				},
				"networkProfile":{
					"networkInterfaceConfigurations":[
					{
						"name":"nic1",
						"properties":{
							"primary":"true",
							"ipConfigurations":[
								{
									"name":"ip1",
									"properties":{
											"subnet":{
													"id":"[variables('subnetRef')]"
											},
											"loadBalancerBackendAddressPools":[
													{"id":"[variables('lbBEAddressPoolID')]"}
											]
										}
									}
								]
							}
						}
					]
				},
				"extensionProfile":{
					"extensions":[
						{
								"name":"iisInstall",
								"properties":{
									"publisher":"Microsoft.Compute",
									"type":"CustomScriptExtension",
									"typeHandlerVersion":"1.4",
									"autoUpgradeMinorVersion":false,
										"settings":{
												"fileUris":["[variables('iisConfigurationScriptLocation')]"],
												"commandToExecute":"[concat('powershell -ExecutionPolicy Unrestricted -file ',variables('iisConfigurationScriptFile'))]"
										}
								}
						}
					]
				}
			}
		}
	}
	],
	"outputs":{
		"fqdn":{
			"value":"[reference(variables('publicIPAddressID'),providers('Microsoft.Network','publicIPAddresses').apiVersions[0]).dnsSettings.fqdn]",
			"type":"string"
		},
		"ipaddress":{
			"value":"[reference(variables('publicIPAddressID'),providers('Microsoft.Network','publicIPAddresses').apiVersions[0]).ipAddress]",
			"type":"string"
		}
	}
}
