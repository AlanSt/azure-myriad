{
	"$schema":"http://schema.management.azure.com/schemas/2015-01-01-preview/deploymentTemplate.json",
	"contentVersion":"1.0.0.0",
	"parameters":{
		"vmSSName":{
			"type":"string",
			"metadata":{
				"description":"The Name of the Scaleset"
			}
		},
		"instanceCount":{
			"type":"string",
			"metadata":{
				"description":"Number of VM instances"
			}
		},
		"newStorageAccountSuffix":{
			"type":"string",
			"metadata":{
				"description":"The Prefix for the names of the new storageaccounts created"
			}
		},
		"dnsNamePrefix":{
			"type":"string",
			"metadata":{
				"description":"The Prefix for the DNSnames of the new IPaddress created"
			}
		},
		"adminUsername":{
			"type":"string",
			"metadata":{
				"description":"The Username of the admininstrative user for each vm created"
			}
		},
		"adminPassword":{
			"type":"securestring",
			"metadata":{
				"description":"The Password of the admininstrative user for each vm created"
			}
		},
		"location":{
			"type":"string",
			"metadata":{
				"description":"Deployment location"
			},
			"defaultValue":"[resourceGroup().location]"
		},
		"baseURL":{
			"type":"string",
			"metadata":{
				"description":"The BaseURL (including container) for the blob containing the custom image"
			}
		},
		"imageBlobName":{
			"type":"string",
			"metadata":{
				"description":"The BaseURL for the blob containing the custom image"
			}
		},
		"frontEndLBPort":{
			"type":"int",
			"metadata":{
				"description":"The front end port to Load Balance"
			},
			"defaultValue":80
		},
		"backEndLBPort":{
			"type":"int",
			"metadata":{
				"description":"The front end port to Load Balance"
			},
			"defaultValue":80
		}
		
	},
	"variables":{
		"imageSource":"[concat(parameters('baseURL'),parameters('imageBlobName'))]",
		"addressPrefix":"10.0.0.0/16",
		"subnetName":"Subnet",
		"subnetPrefix":"10.0.0.0/24",
		"virtualNetworkName":"vmssvnet",
		"vnetID":"[resourceId('Microsoft.Network/virtualNetworks',variables('virtualNetworkName'))]",
		"subnetRef":"[concat(variables('vnetID'),'/subnets/',variables('subnetName'))]",
		"publicIPAddressName":"publicip1",
		"publicIPAddressID":"[resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressName'))]",
		"nicName":"networkInterface1",
		"nicId":"[resourceId('Microsoft.Network/networkInterfaces',variables('nicName'))]",
		"lbName":"loadBalancer1",
		"lbID":"[resourceId('Microsoft.Network/loadBalancers',variables('lbName'))]",
		"lbFEName":"loadBalancerFrontEnd",
		"lbWebProbeName":"loadBalancerWebProbe",
		"lbBEAddressPool":"loadBalancerBEAddressPool",
		"lbFEIPConfigID":"[concat(variables('lbID'),'/frontendIPConfigurations/',variables('lbFEName'))]",
		"lbBEAddressPoolID":"[concat(variables('lbID'),'/backendAddressPools/',variables('lbBEAddressPool'))]",
		"lbWebProbeID":"[concat(variables('lbID'),'/probes/',variables('lbWebProbeName'))]"
	},
	"resources":[
		{
			"apiVersion":"2015-06-15",
			"type":"Microsoft.Network/virtualNetworks",
			"name":"[variables('virtualNetworkName')]",
			"location":"[parameters('location')]",
			"properties":{
				"addressSpace":{
						"addressPrefixes":[
								"[variables('addressPrefix')]"
						]
				},
				"subnets":[
						{
								"name":"[variables('subnetName')]",
								"properties":{
										"addressPrefix":"[variables('subnetPrefix')]"
								}
						}
				]
			}
		},
		{
			"apiVersion":"2015-05-01-preview",
			"type":"Microsoft.Network/publicIPAddresses",
			"name":"[variables('publicIPAddressName')]",
			"location":"[parameters('location')]",
			"properties":{
				"publicIPAllocationMethod":"Dynamic",
				"dnsSettings":{
					"domainNameLabel":"[parameters('dnsNamePrefix')]"
				}
			}
		},
		{
			"apiVersion":"2015-05-01-preview",
			"name":"[variables('lbName')]",
			"type":"Microsoft.Network/loadBalancers",
			"location":"[parameters('location')]",
			"dependsOn":[
					"[concat('Microsoft.Network/publicIPAddresses/',variables('publicIPAddressName'))]"
			],
			"properties":{
				"frontendIPConfigurations":[
					{
						"name":"[variables('lbFEName')]",
						"properties":{
								"publicIPAddress":{
										"id":"[variables('publicIPAddressID')]"
								}
						}
					}
				],
				"backendAddressPools":[
					{
						"name":"[variables('lbBEAddressPool')]"
					}
				],
				"loadBalancingRules":[
					{
						"name":"weblb",
						"properties":{
							"frontendIPConfiguration":{
								"id":"[variables('lbFEIPConfigID')]"
							},
							"backendAddressPool":{
								"id":"[variables('lbBEAddressPoolID')]"
							},
							"probe":{
								"id":"[variables('lbWebProbeID')]"
							},
							"protocol":"tcp",
							"frontendPort":"[parameters('frontEndLBPort')]",
							"backendPort":"[parameters('backEndLBPort')]",
							"enableFloatingIP":false
						}
					}
				],
				"probes":[
					{
						"name":"[variables('lbWebProbeName')]",
						"properties":{
							"protocol":"http",
							"port":"[parameters('backEndLBPort')]",
							"intervalInSeconds":"15",
							"numberOfProbes":"5",
							"requestPath":"/iisstart.htm"
						}
					}
				]
			}
		},
		{
			"type":"Microsoft.Compute/virtualMachineScaleSets",
			"apiVersion":"2015-06-15",
			"name":"[parameters('vmSSName')]",
			"location":"[parameters('location')]",
			"tags":{
				"vmsstag1":"Myriad"
			},
			"dependsOn":[
				"[concat('Microsoft.Network/loadBalancers/',variables('lbName'))]",
				"[concat('Microsoft.Network/virtualNetworks/',variables('virtualNetworkName'))]"

			],
			"sku":{
				"name":"Standard_A2",
				"tier":"Standard",
				"capacity":"[parameters('instanceCount')]"
			},
			"properties":{
				"upgradePolicy":{
				"mode":"Automatic"
				},
				"virtualMachineProfile":{
					"storageProfile":{
						"osDisk":{
							"name":"vmssosdisk",
							"caching":"ReadOnly",
							"createOption":"FromImage",
							"osType": "Windows",
							"image": {
								"uri": "[variables('imageSource')]"
							}
						}
					},
					"osProfile":{
						"computerNamePrefix":"[parameters('vmSSName')]",
						"adminUsername":"[parameters('adminUsername')]",
						"adminPassword":"[parameters('adminPassword')]"
					},
					"networkProfile":{
						"networkInterfaceConfigurations":[
							{
								"name":"nic1",
								"properties":{
									"primary":"true",
									"ipConfigurations":[
									{
											"name":"ip1",
											"properties":{
												"subnet":{
													"id":"[variables('subnetRef')]"
												},
												"loadBalancerBackendAddressPools":[
													{"id":"[variables('lbBEAddressPoolID')]"}
												]
											}
										}
									]
								}
							}
						]
					}
				}
			}
		}
	],
	"outputs":{
		"fqdn":{
			"value":"[reference(variables('publicIPAddressID'),providers('Microsoft.Network','publicIPAddresses').apiVersions[0]).dnsSettings.fqdn]",
			"type":"string"
		},
		"ipaddress":{
			"value":"[reference(variables('publicIPAddressID'),providers('Microsoft.Network','publicIPAddresses').apiVersions[0]).ipAddress]",
			"type":"string"
		}
	}
}
