  {
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01-preview/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters" : {
     "vmSSName": {
      "type": "string"
      },
      "instanceCount" : {
        "type": "string",
        "metadata": {
          "description": "Number of VM instances"
        }
        },
        "newStorageAccountName" : {
         "type": "string"
         },
         "adminUsername": {
          "type": "string"
          },
          "adminPassword": {
           "type": "securestring"
         }
         },
         "variables": {
          "imagePublisher": "CoreOS",
          "imageOffer": "CoreOS",
          "imageVersion": "Stable",
          "addressPrefix": "10.0.0.0/16",
          "subnetName": "Subnet",
          "subnetPrefix": "10.0.0.0/24",
          "virtualNetworkName": "vmssvnet",
          "storageAccountType": "Standard_LRS",
          "maxInstanceCount": 100,
          "virtualMachinesPerStorageAccount": 20,
          "location": "[resourceGroup().location]",
          "storageAccountPrefix": [ 
          "0","6","c","i","o","u","1","7","d","j","p","v", 
          "2","8","e","k","q","w","3","9","f","l","r","x", 
          "4","a","g","m","s","y","5","b","h","n","t","z" 
          ],
          "storageAccountPrefixCount": "[length(variables('storageAccountPrefix'))]"
          },
          "resources": [
          {
              "type": "Microsoft.Storage/storageAccounts",            
              "name": "[concat(variables('storageAccountPrefix')[mod(copyIndex(),variables('storageAccountPrefixCount'))],variables('storageAccountPrefix')[div(copyIndex(),variables('storageAccountPrefixCount'))],parameters('newStorageAccountName'),copyIndex(1))]",
              "apiVersion": "2015-05-01-preview",
              "copy": {
              "name": "storageAccountLoop",
              "count": "[div(variables('maxInstanceCount'), variables('virtualMachinesPerStorageAccount'))]"
              },
              "location": "[variables('location')]",
              "properties": {
                "accountType": "[variables('storageAccountType')]"
              }
              },
              {
                "apiVersion": "2015-06-15",
                "type": "Microsoft.Network/virtualNetworks",
                "name": "[variables('virtualNetworkName')]",
                "location": "[variables('location')]",
                "properties": {
                  "addressSpace": {
                    "addressPrefixes": [
                    "[variables('addressPrefix')]"
                    ]
                    },
                    "subnets": [
                    {
                      "name": "[variables('subnetName')]",
                      "properties": {
                        "addressPrefix": "[variables('subnetPrefix')]"
                      }
                    }
                    ]
                  }
                  },
                  {
                    "type": "Microsoft.Compute/virtualMachineScaleSets",
                    "apiVersion": "2015-06-15",
                    "name": "[parameters('vmSSName')]",
                    "location": "[variables('location')]",
                    "tags": {
                      "vmsstag1": "Myriad"
                      },
                      "dependsOn": [
                      "[storageAccountLoop]"                      
                      ],
                      "sku": {
                       "name": "Standard_A2",
                       "tier": "Standard",
                       "capacity": "[parameters('instanceCount')]"
                       },
                       "properties": {
                         "upgradePolicy": {
                           "mode": "Automatic"
                           },
                           "virtualMachineProfile": {
                            "storageProfile": {
                              "osDisk": {
                                "vhdContainers": [
                                "[concat('https://a', parameters('newStorageAccountName'), '.blob.core.windows.net/vmss')]",
                                "[concat('https://j', parameters('newStorageAccountName'), '.blob.core.windows.net/vmss')]",
                                "[concat('https://p', parameters('newStorageAccountName'), '.blob.core.windows.net/vmss')]",
                                "[concat('https://u', parameters('newStorageAccountName'), '.blob.core.windows.net/vmss')]",
                                "[concat('https://z', parameters('newStorageAccountName'), '.blob.core.windows.net/vmss')]"
                                ],
                                "name": "vmssosdisk",
                                "caching": "ReadOnly",
                                "createOption": "FromImage"
                                },
                                "imageReference": {
                                  "publisher": "[variables('imagePublisher')]",
                                  "offer": "[variables('imageOffer')]",
                                  "sku": "[variables('imageVersion')]",
                                  "version": "latest"
                                }
                                },
                                "osProfile": {
                                  "computerNamePrefix": "[parameters('vmSSName')]",
                                  "adminUsername": "[parameters('adminUsername')]",
                                  "adminPassword": "[parameters('adminPassword')]"
                                  },
                                  "networkProfile": {
                                    "networkInterfaceConfigurations": [
                                    {
                                     "name": "nic1",
                                     "properties": {
                                       "primary": "true",
                                       "ipConfigurations": [
                                       {
                                        "name": "ip1",
                                        "properties": {
                                          "subnet": {
                                            "id": "[concat('/subscriptions/', subscription().subscriptionId,'/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'), '/subnets/', variables('subnetName'))]"
                                          }
                                        }
                                      }
                                      ]
                                    }
                                  }
                                  ]
                                }
                              }
                            }
                          }
                          ]
                        }

